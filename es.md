## elasticsearch基本概念
> 学技术吗，总要搞清楚弄明白，这样出现问题才能不慌。
## 概念
* 通过学习以及个人理解整理
* elastic的基本信息应该都有所了解就不过多赘述，刚开始我也同样有很多问题需要弄清楚，不能只会用还要深入了解。
* 首先就要了解es的倒排索引
  1. 什么是倒排索引？es在插入数据的时候会维护一张倒排索引表，可以极大的提高检索效率。一般我们查询一个数据都是通过key找value，而倒排索引简单来说既是通过value找key。
     举个例子，比如有个表里面有id和detail两个数据detail放在文章信息，我们插入数据的时候es会对detail进行分词，比如我插入一条id为`1`，detail为`心情不好`，es
     会对这句话进行分词为`心情`、`不好`，表示这两个词都对应id为1的数据
     ```
     心情  [1]
     不好  [1]
     ```
     我们继续往里插入一条数据
     ```
     id: 2
     detail: 今天心情不好
     ```
     这时就变成
     ```
     心情  [1,2]
     不好  [1,2]
     今天  [2]
     ```
  2. 通过以上插入的数据，检索`心情`，就会命中两条数据[1,2]   
* 了解es的文档存储
  1. es是面向文档型数据存储库，一条数据在这里就是一个文档，用json做序列化。用过mysql在使用es很容易就让我们产出对应的感觉
    ```
    关系数据库      => 数据库       => 表         => 行            => 列(Columns)

    Elasticsearch => 索引(Index)  => 类型(type) => 文档(Docments) => 字段(Fields)  
    ```
  2. 索引
  > 索引的不变性  
  由于倒排索引的结构特性，在索引建立完成后对其进行修改将会非常复杂。再加上几层索引嵌套，更让索引的更新变成了几乎不可能的动作。
  所以索性设计成不可改变的：倒排索引被写入磁盘后是不可改变的，它永远不会修改。

  > 不变性有重要的价值：  
  1.不需要锁。如果你从来不更新索引，你就不需要担心多进程同时修改数据的问题。
  2.一旦索引被读入内核的文件系统缓存，便会留在哪里，由于其不变性。只要文件系统缓存中还有足够的空间，那么大部分读请求会直接请求内存，而不会命中磁盘。这提供了很大的性能提升。
  3.其它缓存(像filter缓存)，在索引的生命周期内始终有效。它们不需要在每次数据改变时被重建，因为数据不会变化。
  4.写入单个大的倒排索引允许数据压缩，减少磁盘 I/O 和 需要被缓存到内存的索引的使用量。
 
  3.集群
  > 节点角色  
  > 1. master节点：负责保存和更新集群的一些元数据信息，之后同步到所有节点，所以每个节点都需要保存全量的元数据信息：
  > ```
  > 1. 集群的配置信息  
  > 2. 集群的节点信息  
  > 3. 模板template设置  
  > 4. 索引以及对应的设置、mapping、分词器和别名  
  > 5. 索引关联到的分片以及分配到的节点  
  > ```
  > 2. data节点：负责数据存储和查询
  > 3. coordinator节点：
  > ```
  > 路由索引请求
  > 聚合搜索结果集
  > 分发批量索引请求
  > ```
  > 4. 选举机制  
  > **master选举**    
  > a. 选举策略  
  > 如果集群中存在master，认可该master，加入集群
  > 如果集群中不存在master，从具有master资格的节点中选id最小的节点作为master  
  > b. 选举时机  
  > 集群启动：后台启动线程去ping集群中的节点，按照上述策略从具有master资格的节点中选举出master
  > 现有的master离开集群：后台一直有一个线程定时ping master节点，超过一定次数没有ping成功之后，重新进行master的选举  
  > c. 避免脑裂  
  > 脑裂问题是采用master-slave模式的分布式集群普遍需要关注的问题，脑裂一旦出现，会导致集群的状态出现不一致，导致数据错误甚至丢失。
  > ES避免脑裂的策略：过半原则，可以在ES的集群配置中添加一下配置，避免脑裂的发生 (节点数/2 + 1)
  > ```
  

    

## 文章引用
* [理解ElasticSearch原理](https://www.jianshu.com/p/52b92f1a9c47)
* [elasticsearch脑裂解释](https://segmentfault.com/a/1190000004504225)
    